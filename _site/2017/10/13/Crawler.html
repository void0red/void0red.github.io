<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <meta name="author" content="void0red"> <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="shortcut icon" href="/assets/img/favicon.png" /> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://localhost:4000/2017/10/13/Crawler.html"> <!-- Begin Jekyll SEO tag v2.3.0 --> <title>Crawler Sharing | void0red’s blog</title> <meta property="og:title" content="Crawler Sharing" /> <meta name="author" content="void0red" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="一次爬虫的记录与分享" /> <meta property="og:description" content="一次爬虫的记录与分享" /> <link rel="canonical" href="http://localhost:4000/2017/10/13/Crawler.html" /> <meta property="og:url" content="http://localhost:4000/2017/10/13/Crawler.html" /> <meta property="og:site_name" content="void0red’s blog" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2017-10-13T00:00:00+08:00" /> <script type="application/ld+json"> {"name":null,"description":"一次爬虫的记录与分享","author":{"@type":"Person","name":"void0red"},"@type":"BlogPosting","url":"http://localhost:4000/2017/10/13/Crawler.html","publisher":null,"image":null,"headline":"Crawler Sharing","dateModified":"2017-10-13T00:00:00+08:00","datePublished":"2017-10-13T00:00:00+08:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017/10/13/Crawler.html"},"@context":"http://schema.org"}</script> <!-- End Jekyll SEO tag --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <script src="/assets/js/prefixfree.js"></script> </head> <body> <script type="text/javascript" color="153,102,204" opacity='1' src="/assets/js/canvas-nest.min.js"></script> <aside id="sidebar" class="open"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/avatar.jpg"/> </a> <div id="sidebar-social"> <a href="/pages/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:void0red@gmail.com" class="sidebar-social-icon email"></a> <!-- Generate icon by yourself https://icomoon.io/app/#/select --> <a href="https://github.com/void0red" class="sidebar-social-icon github" target="_blank"></a> </div> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="recent">最新文章</li> <li class="sidebar-tag" data-filter="others">others</li> <li class="sidebar-tag" data-filter="c">c</li> <li class="sidebar-tag" data-filter="bin">bin</li> <li class="sidebar-tag" data-filter="pwn">pwn</li> </ul> <div> <object type="application/x-shockwave-flash" style="outline:none;" data="/pic/hamster.swf" width="120" height="90"><param name="movie" value="http://cdn.abowman.com/widgets/hamster/hamster.swf?"></param><param name="AllowScriptAccess" value="always"></param><param name="wmode" value="opaque"></param></object> </div> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <a class="toc-link" data-tags="pwn" href="/2017/11/09/overflow.html"> overflow </a> <a class="toc-link" data-tags="others" href="/2017/11/05/a-letter.html"> a letter </a> <a class="toc-link" data-tags="bin" href="/2017/10/21/try_assembly_0.html"> try_assembly_0 </a> <a class="toc-link" data-tags="others" href="/2017/10/13/Crawler.html"> Crawler Sharing </a> <a class="toc-link" data-tags="c" href="/2017/10/07/struct.html"> About learning c struct </a> <a class="toc-link" data-tags="c" href="/2017/10/07/linked_list.html"> About learning linked_list </a> <a class="toc-link" data-tags="others" href="/2017/09/24/mysql.html"> About learning MYSQL </a> </nav> </div> </aside> <main id="main" class="open"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2017 October 13</span> <span class="post-meta-span tag">others</span> </div> <h1 class="post-title">Crawler Sharing</h1> <blockquote> <p>一次爬虫的记录与分享</p> </blockquote> <h1 id="0x00准备">0x00准备</h1> <p>安装selenium库，使用urllib库，re库</p> <h1 id="0x01实现">0x01实现</h1> <h3 id="selenium模拟登录">selenium模拟登录</h3> <p>emmm,起因是为了实现自动在qzone发送说说，然后到github上去翻了翻，发现轮子都已经失效了（<del>大概没人喜欢做这么无聊的事吧</del> 登录qzone: i.qq.com，查看到qzone的登录是利用js实现的 <img src="https://raw.githubusercontent.com/void0red/Pictures/master/blog/crawler0.jpg" alt="" /></p> <p>并没有想去分析qzone的js算法，决定使用selenium模拟登录qzone，不难操作，然后取得当前页面，也就是登录完成的页面的cookie，（注意！用sleep来等待大量数据加载完成，许多操作不能达到预计效果可能是因为网络不佳造成的）</p> <p>除了cookie，还有当前页面的源代码也要保存下来（笑</p> <h3 id="分析说说发送过程">分析说说发送过程</h3> <p>在首页随便发送一条说说，截获一条post请求</p> <p><img src="https://raw.githubusercontent.com/void0red/Pictures/master/blog/crawler1.png" alt="" /></p> <p>分析结构，发现请求地址很长</p> <div class="highlighter-rouge"><pre class="highlight"><code>https://user.qzone.qq.com/proxy/domain/taotao.qzone.qq.com/cgi-bin/emotion_cgi_publish_v6?g_tk=91245527&amp;qzonetoken=010dee36790ae077dbba7521e3e0838b6d9ef25271a9260c8040cd2c2e976f58f614e3ab913c683dfb5c90
</code></pre></div> <p>前面一部分是固定的（除非人为的话，后面有两个参数g_tk和qzonetoken，这是两个为了加密而设置的参数，通过js来获得，qzonetoken的函数源码没有找到，查询网络上的也是一些过时的（算法早就改变了，于是我从主页的源码中扣下来，在最底下，用正则来截取</p> <p><img src="https://raw.githubusercontent.com/void0red/Pictures/master/blog/crawler2.png" alt="" /></p> <p>g_tk无法在源码中找到，于是刷新主页，查到在一个<code class="highlighter-rouge">interface_mini.js?max_age=60628</code>的js文件里有定义</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code>  <span class="nx">QZONE</span><span class="p">.</span><span class="nx">FrontPage</span><span class="p">.</span><span class="nx">getACSRFToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="nx">QZFL</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">URI</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">skey</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">host</span> <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"qzone.qq.com"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">skey</span> <span class="o">=</span> <span class="nx">QZFL</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"p_skey"</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">host</span> <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"qq.com"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">skey</span> <span class="o">=</span> <span class="nx">QZFL</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"skey"</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">skey</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">skey</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">QZFL</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"p_skey"</span><span class="p">)</span> <span class="o">||</span> <span class="s2">""</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">skey</span> <span class="o">=</span> <span class="nx">QZFL</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"p_skey"</span><span class="p">)</span> <span class="o">||</span> <span class="s2">""</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">skey</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">skey</span> <span class="o">=</span> <span class="nx">QZFL</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"skey"</span><span class="p">)</span> <span class="o">||</span> <span class="nx">QZFL</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"rv2"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="mi">5381</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">skey</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hash</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="nx">skey</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">charCodeAt</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="mi">2147483647</span><span class="p">;</span>
  <span class="p">};</span>
</code></pre></div> <p>简单分析一下，用python来重写了g_tk的计算函数（这种操作会因为腾×更新算法而失效，而腾×的更新恰好是比较快的2333</p> <h3 id="urllib发送post请求">urllib发送post请求</h3> <p>没啥好说的，构造post请求头，主体，发送请求</p> <p>源码地址：https://github.com/void0red/code/blob/master/qzone.py</p> <h1 id="0x03后记">0x03后记</h1> <p><del>最滑稽的是，这个爬虫并没有实现，运行结果是Bad Request，233333</del></p> <p>已经解决，问题在于没有计算请求头中Content-Length的值（笑</p> <p>总的来说，程序可用性不高：</p> <ol> <li>登录是用selenium实现的，加载会占用大量内存与cpu，不适宜在小型设备（例如树莓派）上运行</li> <li>两个加密函数有时效性，qzonetoken还好，g_tk的计算就显得有些鸡肋，一旦腾×更改其中的某段代码中的某个参数值，该爬虫就得重新编写（事实上他也是这么做的，可以考虑用正则把js扣出来，放在本地运行，这样程序大概能健壮一些</li> <li>程序容错率不高，一旦有环节出错，整个过程无法实现</li> </ol> <p><del>可喜的是，终于成功爬了qzone，2333</del></p> <blockquote> <p>void0red 2017.10.13</p> </blockquote> </article> <div class="footer"> <div class="container"> <p class="footer-entry">All content is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA</a></p> <p class="footer-entry">Buit with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll theme</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <button id="menu" class="open"> <span id="menu-icons"></span> </button> <button id="post-toc-menu"> <span id="post-toc-menu-icons"></span> </button> <div id="post-toc"> <span id="post-toc-title">Table of Contents</span> <ul id="post-toc-ul"></ul> </div> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> </body> </html>
